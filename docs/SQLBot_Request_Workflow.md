# SQLBot 请求处理工作流文档

本文档详细描述 SQLBot 的请求处理流程，包括 LLM 调用链路和前后端协作机制。

---

## 目录

1. [总体架构概览](#1-总体架构概览)
2. [LLM 调用工作流](#2-llm-调用工作流)
3. [前后端协作流程](#3-前后端协作流程)
4. [关键文件索引](#4-关键文件索引)

---

## 1. 总体架构概览

### 1.1 请求处理主流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户提问                                        │
│                   "查询各信用评级的债券平均收益率"                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            初始化阶段                                        │
│  • 加载 LLM 配置  • 创建 LLMService 实例  • 加载对话历史（最近6条）            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │    是否已选择数据源?     │
                         └────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ 否                               │ 是
                    ▼                                  ▼
        ┌───────────────────┐              ┌───────────────────┐
        │  LLM调用 #1       │              │   跳过此步骤       │
        │  选择数据源        │              │                   │
        └───────────────────┘              └───────────────────┘
                    │                                  │
                    └─────────────────┬────────────────┘
                                      ▼
                    ┌─────────────────────────────────┐
                    │         LLM调用 #2              │
                    │        生成 SQL 语句            │
                    └─────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │   是否需要行级权限过滤?   │
                         └────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ 是                               │ 否
                    ▼                                  │
        ┌───────────────────┐                         │
        │  LLM调用 #3       │                         │
        │  添加权限过滤条件   │                         │
        └───────────────────┘                         │
                    │                                  │
                    └─────────────────┬────────────────┘
                                      ▼
                         ┌────────────────────────┐
                         │  是否为动态数据源类型?   │
                         └────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │ 是                               │ 否
                    ▼                                  │
        ┌───────────────────┐                         │
        │  LLM调用 #4       │                         │
        │  生成动态SQL       │                         │
        └───────────────────┘                         │
                    │                                  │
                    └─────────────────┬────────────────┘
                                      ▼
                    ┌─────────────────────────────────┐
                    │        执行 SQL（无LLM）          │
                    │     通过 db.py 查询数据库         │
                    └─────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────┐
                    │         LLM调用 #5              │
                    │      生成图表配置               │
                    └─────────────────────────────────┘
                                      │
                                      ▼
                    ┌─────────────────────────────────┐
                    │          响应完成                │
                    │    （数据 + 图表展示给用户）      │
                    └─────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │    用户是否需要更多?     │
                         └────────────────────────┘
                                      │
              ┌───────────────────────┼───────────────────────┐
              │ /analysis             │ /predict              │ (无)
              ▼                       ▼                       ▼
  ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐
  │  LLM调用 #6       │   │  LLM调用 #7       │   │       结束         │
  │  数据分析         │   │  数据预测         │   │                   │
  └───────────────────┘   └───────────────────┘   └───────────────────┘
```

---

## 2. LLM 调用工作流

### 2.1 LLM调用 #1：数据源选择（条件调用）

**触发条件**：用户未指定数据源且存在多个可用数据源

**代码位置**：`backend/apps/chat/task/llm.py` → `select_datasource()` (第398-544行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     LLM调用 #1：选择数据源                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → datasource.system/user         │
│  生成代码: backend/apps/chat/models/chat_model.py → datasource_sys_question()│
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  你是一个数据分析师，根据用户提问和数据源列表，                          │
│  │  找出最符合用户提问的数据源。                                           │
│  │  返回格式: {"id": 数据源ID} 或 {"fail": "原因"}                         │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  数据源列表: [{"id":1,"name":"债券数据库","description":"..."},...]     │
│  │  问题: {用户的问题}                                                     │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  成功: {"id": 1}                                                       │
│  │  失败: {"fail": "没有找到匹配的数据源"}                                  │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 LLM调用 #2：SQL生成（必须调用）

**触发条件**：始终调用，这是核心功能

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_sql()` (第546-580行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LLM调用 #2：生成SQL                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → sql.system/user                 │
│  生成代码: backend/apps/chat/models/chat_model.py → sql_sys_question()       │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <Instruction>                                                        │   │
│  │    你是"SQLBOT"，智能问数小助手。                                       │   │
│  │    根据表结构和用户问题生成SQL语句、对话标题、图表类型。                   │   │
│  │  </Instruction>                                                       │   │
│  │                                                                       │   │
│  │  <Rules>                                                              │   │
│  │    • 只能生成查询SQL，不能生成增删改                                    │   │
│  │    • 不要编造表结构中没有的表/字段                                      │   │
│  │    • SQL必须符合数据库引擎规范                                          │   │
│  │    • 返回JSON格式                                                      │   │
│  │    • 默认限制1000条数据                                                │   │
│  │  </Rules>                                                             │   │
│  │                                                                       │   │
│  │  <Info>                                                               │   │
│  │    <db-engine> MySQL 8.0 </db-engine>                                 │   │
│  │    <m-schema> 表结构信息 </m-schema>                                   │   │
│  │    <terminologies> 术语定义 </terminologies>                           │   │
│  │    <sql-examples> SQL示例 </sql-examples>                             │   │
│  │  </Info>                                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <background-infos>                                                    │   │
│  │    <current-time>2025-01-15 14:30:00</current-time>                    │   │
│  │  </background-infos>                                                   │   │
│  │  <error-msg> 上次SQL执行错误（如有） </error-msg>                       │   │
│  │  <user-question> 用户问题 </user-question>                             │   │
│  │  <change-title> True/False </change-title>                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  成功:                                                                 │   │
│  │  {                                                                     │   │
│  │    "success": true,                                                    │   │
│  │    "sql": "SELECT rating, AVG(yield) FROM bonds GROUP BY rating",      │   │
│  │    "tables": ["bonds"],                                                │   │
│  │    "chart-type": "column",                                             │   │
│  │    "brief": "债券收益率按评级分布"                                       │   │
│  │  }                                                                     │   │
│  │                                                                        │   │
│  │  失败:                                                                 │   │
│  │  {"success": false, "message": "无法生成SQL的原因"}                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.3 LLM调用 #3：权限过滤（条件调用）

**触发条件**：用户配置了行级权限

**代码位置**：`backend/apps/chat/task/llm.py` → `build_table_filter()` (第640-688行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     LLM调用 #3：添加权限过滤                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → permissions.system/user         │
│  生成代码: backend/apps/chat/models/chat_model.py → filter_sys_question()    │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  在给定SQL基础上，根据过滤条件列表，将过滤条件添加到SQL中。                │   │
│  │  • 必须以原SQL为基础，不要替换原有条件                                   │   │
│  │  • 给字段加上表别名                                                     │   │
│  │  • 去重冗余条件                                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <sql> 原始SQL </sql>                                                  │   │
│  │  <filter-list>                                                         │   │
│  │    [{"table":"bonds","filter":"desk='DESK_A'"},...]                    │   │
│  │  </filter-list>                                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {"success": true, "sql": "带有权限过滤条件的新SQL"}                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 LLM调用 #4：动态SQL（条件调用）

**触发条件**：Assistant 数据源类型（type=1或3）

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_with_sub_sql()` (第582-623行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LLM调用 #4：动态SQL                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → dynamic_sql.system/user         │
│  生成代码: backend/apps/chat/models/chat_model.py → dynamic_sys_question()   │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  将SQL中的表名替换为对应的子查询。                                       │   │
│  │  • 严格保持原始SQL结构不变                                              │   │
│  │  • 子查询映射格式: [{"table":"表名","query":"子查询"},...]               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  sql: SELECT * FROM bonds WHERE rating = 'AAA'                         │   │
│  │  子查询映射表: [{"table":"bonds","query":"SELECT * FROM api_data"}]     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {"success": true, "sql": "SELECT * FROM (子查询) AS bonds WHERE..."}   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.5 LLM调用 #5：图表配置生成（必须调用）

**触发条件**：SQL执行成功后始终调用

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_chart()` (第700-734行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     LLM调用 #5：生成图表配置                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → chart.system/user               │
│  生成代码: backend/apps/chat/models/chat_model.py → chart_sys_question()     │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据SQL和用户问题生成数据可视化图表配置。                                │   │
│  │  支持图表类型: table | column | bar | line | pie                        │   │
│  │                                                                       │   │
│  │  格式要求:                                                             │   │
│  │  • 表格: {"type":"table","columns":[{"name":"列名","value":"字段"}]}    │   │
│  │  • 柱状图: {"type":"column","axis":{"x":{...},"y":{...},"series":{...}}}│   │
│  │  • 饼图: {"type":"pie","axis":{"y":{...},"series":{...}}}               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <user-question> 用户问题 </user-question>                             │   │
│  │  <sql> 生成的SQL语句 </sql>                                            │   │
│  │  <chart-type> SQL生成阶段推荐的图表类型 </chart-type>                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                     │   │
│  │    "type": "column",                                                   │   │
│  │    "title": "债券平均收益率按评级分布",                                   │   │
│  │    "axis": {                                                           │   │
│  │      "x": {"name": "信用评级", "value": "rating"},                      │   │
│  │      "y": {"name": "平均收益率", "value": "avg_yield"}                  │   │
│  │    }                                                                   │   │
│  │  }                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.6 LLM调用 #6：数据分析（按需调用）

**触发条件**：用户触发 `/analysis` 命令

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_analysis()` (第242-292行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LLM调用 #6：数据分析                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → analysis.system/user            │
│  生成代码: backend/apps/chat/models/chat_model.py → analysis_sys_question()  │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据给定的数据进行分析，给出分析结果。                                   │   │
│  │  • 参考<terminologies>中的术语帮助理解数据                               │   │
│  │  • 使用指定语言回答                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <fields> ["rating", "avg_yield"] </fields>                            │   │
│  │  <data>                                                                │   │
│  │    [{"rating":"AAA","avg_yield":0.032},                                │   │
│  │     {"rating":"AA+","avg_yield":0.038}, ...]                           │   │
│  │  </data>                                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  自然语言分析报告（流式输出）                                            │   │
│  │                                                                        │   │
│  │  ## 分析结果                                                           │   │
│  │  1. 信用评级与收益率呈负相关...                                         │   │
│  │  2. 投资级与高收益级分界明显...                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.7 LLM调用 #7：数据预测（按需调用）

**触发条件**：用户触发 `/predict` 命令

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_predict()` (第294-341行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LLM调用 #7：数据预测                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → predict.system/user             │
│  生成代码: backend/apps/chat/models/chat_model.py → predict_sys_question()   │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据给定数据进行预测。                                                 │   │
│  │  • 预测数据至少2个周期                                                  │   │
│  │  • 返回JSON数组格式                                                     │   │
│  │  • 只返回预测部分，不包含原有数据                                        │   │
│  │  • 无法预测时返回文字说明                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  <fields> ["month", "yield"] </fields>                                 │   │
│  │  <data>                                                                │   │
│  │    [{"month":"2024-01","yield":0.042},                                 │   │
│  │     {"month":"2024-02","yield":0.044}, ...]                            │   │
│  │  </data>                                                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  成功:                                                                 │   │
│  │  [                                                                     │   │
│  │    {"month":"2024-07","yield":0.053},                                  │   │
│  │    {"month":"2024-08","yield":0.055}                                   │   │
│  │  ]                                                                     │   │
│  │                                                                        │   │
│  │  失败:                                                                 │   │
│  │  "抱歉，该数据无法进行预测。数据点不足以识别明确趋势。"                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.8 LLM调用 #8：问题推荐（按需调用）

**触发条件**：用户完成问答后调用

**代码位置**：`backend/apps/chat/task/llm.py` → `generate_recommend_questions_task()` (第343-396行)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      LLM调用 #8：问题推荐                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Prompt 位置】                                                             │
│  模板文件: backend/templates/template.yaml → guess.system/user               │
│  生成代码: backend/apps/chat/models/chat_model.py → guess_sys_question()     │
│                                                                             │
│  【System Prompt 概要】                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  根据表结构、用户问题和历史提问，推测用户可能的后续问题。                  │   │
│  │  • 推测问题需与表结构相关                                               │   │
│  │  • 不能与当前问题重复                                                   │   │
│  │  • 返回JSON数组格式                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【User Prompt 概要】                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  表结构: {schema}                                                      │   │
│  │  当前问题: {question}                                                  │   │
│  │  历史提问: ["问题1", "问题2", ...]                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【LLM 输出格式】                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ["推荐问题1", "推荐问题2", "推荐问题3", "推荐问题4"]                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.9 LLM调用汇总表

| 序号 | LLM调用 | 触发条件 | 输入 | 输出 | 代码位置 |
|:---:|---------|---------|------|------|---------|
| 1 | 数据源选择 | 未指定数据源 | 数据源列表+问题 | `{"id":N}` | `llm.py:398-544` |
| 2 | SQL生成 | 始终 | Schema+术语+问题 | `{"success":true,"sql":"...","chart-type":"..."}` | `llm.py:546-580` |
| 3 | 权限过滤 | 有行权限 | 原SQL+过滤规则 | `{"success":true,"sql":"..."}` | `llm.py:640-688` |
| 4 | 动态SQL | 动态数据源 | SQL+子查询映射 | `{"success":true,"sql":"..."}` | `llm.py:582-623` |
| - | DB执行 | 始终(非LLM) | 最终SQL | `{"fields":[...],"data":[...]}` | `db.py:450-563` |
| 5 | 图表配置 | 始终 | SQL+问题+推荐类型 | `{"type":"...","axis":{...}}` | `llm.py:700-734` |
| 6 | 数据分析 | `/analysis`命令 | 字段+数据+术语 | 自然语言分析 | `llm.py:242-292` |
| 7 | 数据预测 | `/predict`命令 | 字段+数据 | JSON预测数据 | `llm.py:294-341` |
| 8 | 问题推荐 | 问答完成后 | Schema+问题+历史 | JSON问题数组 | `llm.py:343-396` |

---

## 3. 前后端协作流程

### 3.1 整体协作架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端 (Vue 3)                                    │
│                                                                             │
│  ┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐    │
│  │  ChartAnswer.vue │    │   request.ts     │    │   ChartBlock.vue    │    │
│  │  (流式响应处理)   │◄──│  (fetchStream)   │    │   (图表渲染)         │    │
│  └─────────────────┘    └──────────────────┘    └─────────────────────┘    │
│           │                      │                        ▲                 │
│           │                      │                        │                 │
│           ▼                      ▼                        │                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        SSE 事件解析                                   │   │
│  │    data:{"type":"sql","content":"..."}  →  更新 record.sql           │   │
│  │    data:{"type":"chart","content":"..."} →  更新 record.chart        │   │
│  │    data:{"type":"sql-data"} →  调用 getChatData() 获取数据           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    │ HTTP POST + SSE 流式响应
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             后端 (FastAPI)                                   │
│                                                                             │
│  ┌─────────────────┐    ┌──────────────────┐    ┌─────────────────────┐    │
│  │   chat.py       │    │    llm.py        │    │    db.py            │    │
│  │  (API端点)       │───►│  (LLM服务)       │───►│  (数据库执行)        │    │
│  └─────────────────┘    └──────────────────┘    └─────────────────────┘    │
│           │                      │                                          │
│           │                      │                                          │
│           ▼                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    StreamingResponse                                  │   │
│  │    yield 'data:{"type":"...","content":"..."}\n\n'                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.2 API 接口清单

#### 核心问答接口

| 方法 | 接口路径 | 描述 | 响应类型 |
|:---:|---------|------|---------|
| POST | `/api/v1/chat/question` | 提问（主接口） | SSE流式 |
| GET | `/api/v1/chat/record/{id}/data` | 获取查询数据 | JSON |
| POST | `/api/v1/chat/record/{id}/analysis` | 数据分析 | SSE流式 |
| POST | `/api/v1/chat/record/{id}/predict` | 数据预测 | SSE流式 |
| POST | `/api/v1/chat/recommend_questions/{id}` | 问题推荐 | SSE流式 |

#### 会话管理接口

| 方法 | 接口路径 | 描述 | 响应类型 |
|:---:|---------|------|---------|
| GET | `/api/v1/chat/list` | 获取会话列表 | JSON |
| GET | `/api/v1/chat/{id}` | 获取会话详情 | JSON |
| POST | `/api/v1/chat/start` | 创建新会话 | JSON |
| POST | `/api/v1/chat/rename` | 重命名会话 | JSON |
| DELETE | `/api/v1/chat/{id}/{brief}` | 删除会话 | JSON |

---

### 3.3 SSE 事件类型详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SSE 事件流时序                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  时间线 →                                                                   │
│  ────────────────────────────────────────────────────────────────────────►  │
│                                                                             │
│  [0ms]     用户发送问题                                                     │
│            │                                                                │
│  [50ms]    ├─► data:{"type":"id","id":123}                                 │
│            │   → 前端: 记录 record.id                                       │
│            │                                                                │
│  [100ms]   ├─► data:{"type":"question","question":"查询..."}               │
│            │   → 前端: 显示用户问题                                         │
│            │                                                                │
│  [200ms]   │   ┌─────────────────────────────────┐                         │
│            │   │ LLM调用 #2: SQL生成 (流式)       │                         │
│            │   └─────────────────────────────────┘                         │
│  [300ms]   ├─► data:{"type":"sql-result","content":"SELECT..."}            │
│  [400ms]   ├─► data:{"type":"sql-result","content":"rating..."}            │
│  [500ms]   ├─► data:{"type":"sql-result","content":"FROM..."}              │
│            │   → 前端: 流式显示 reasoning_content                           │
│            │                                                                │
│  [600ms]   ├─► data:{"type":"info","msg":"sql generated"}                  │
│            │                                                                │
│  [650ms]   ├─► data:{"type":"brief","brief":"债券收益率分析"}               │
│            │   → 前端: 更新会话标题                                         │
│            │                                                                │
│  [700ms]   ├─► data:{"type":"sql","content":"SELECT rating..."}            │
│            │   → 前端: 记录 record.sql，显示格式化SQL                       │
│            │                                                                │
│  [900ms]   │   ┌─────────────────────────────────┐                         │
│            │   │ 执行 SQL 查询数据库              │                         │
│            │   └─────────────────────────────────┘                         │
│  [1000ms]  ├─► data:{"type":"sql-data","content":"execute-success"}        │
│            │   → 前端: 调用 getChatData(recordId) 获取数据                  │
│            │                                                                │
│  [1100ms]  │   ┌─────────────────────────────────┐                         │
│            │   │ LLM调用 #5: 图表配置 (流式)      │                         │
│            │   └─────────────────────────────────┘                         │
│  [1200ms]  ├─► data:{"type":"chart-result","content":"生成柱状图..."}      │
│            │   → 前端: 流式显示思考过程                                     │
│            │                                                                │
│  [1400ms]  ├─► data:{"type":"info","msg":"chart generated"}                │
│            │                                                                │
│  [1500ms]  ├─► data:{"type":"chart","content":"{\"type\":\"column\"...}"}  │
│            │   → 前端: 记录 record.chart，渲染图表                          │
│            │                                                                │
│  [1600ms]  └─► data:{"type":"finish"}                                      │
│                → 前端: 标记完成，启用工具栏                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### SSE 事件类型表

| 事件类型 | 数据结构 | 描述 | 前端处理 |
|---------|---------|------|---------|
| `id` | `{"type":"id","id":123}` | 记录ID | 保存 `record.id` |
| `regenerate_record_id` | `{"type":"regenerate_record_id","regenerate_record_id":122}` | 重新生成关联ID | 保存关联ID |
| `question` | `{"type":"question","question":"..."}` | 用户问题 | 显示问题 |
| `info` | `{"type":"info","msg":"..."}` | 信息提示 | 控制台输出 |
| `brief` | `{"type":"brief","brief":"..."}` | 会话标题 | 更新会话名 |
| `sql-result` | `{"type":"sql-result","content":"...","reasoning_content":"..."}` | SQL生成过程 | 流式显示思考 |
| `sql` | `{"type":"sql","content":"..."}` | 最终SQL | 保存并显示SQL |
| `sql-data` | `{"type":"sql-data","content":"execute-success"}` | 数据就绪 | 调用数据接口 |
| `chart-result` | `{"type":"chart-result","content":"...","reasoning_content":"..."}` | 图表生成过程 | 流式显示思考 |
| `chart` | `{"type":"chart","content":"..."}` | 图表配置JSON | 保存并渲染图表 |
| `datasource` | `{"type":"datasource","id":1,"datasource_name":"..."}` | 数据源信息 | 更新数据源 |
| `error` | `{"type":"error","content":"..."}` | 错误信息 | 显示错误 |
| `finish` | `{"type":"finish"}` | 完成 | 标记完成 |
| `analysis-result` | `{"type":"analysis-result","content":"..."}` | 分析结果 | 流式显示分析 |
| `analysis_finish` | `{"type":"analysis_finish"}` | 分析完成 | 标记分析完成 |
| `predict-result` | `{"type":"predict-result","content":"..."}` | 预测结果 | 流式显示预测 |
| `predict-success` | `{"type":"predict-success"}` | 预测成功 | 获取预测数据 |
| `predict_finish` | `{"type":"predict_finish"}` | 预测完成 | 标记预测完成 |
| `recommended_question` | `{"type":"recommended_question","content":"[...]"}` | 推荐问题 | 显示推荐 |

---

### 3.4 数据格式

#### 请求格式

**问题请求** (`POST /api/v1/chat/question`)
```json
{
  "question": "查询各信用评级的债券平均收益率",
  "chat_id": 123,
  "regenerate_record_id": null
}
```

#### 响应格式

**图表数据** (`GET /api/v1/chat/record/{id}/data`)
```json
{
  "fields": ["rating", "avg_yield"],
  "data": [
    {"rating": "AAA", "avg_yield": 0.032},
    {"rating": "AA+", "avg_yield": 0.038},
    {"rating": "AA", "avg_yield": 0.042}
  ],
  "limit": null
}
```

**图表配置** (SSE `chart` 事件的 content)
```json
{
  "type": "column",
  "title": "债券平均收益率按评级分布",
  "axis": {
    "x": {"name": "信用评级", "value": "rating"},
    "y": {"name": "平均收益率", "value": "avg_yield"}
  }
}
```

---

### 3.5 前端流式响应处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ChartAnswer.vue 流式响应处理                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 发起请求                                                                │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │  const response = await questionApi.add(param, controller)       │    │
│     │  const reader = response.body.getReader()                        │    │
│     │  const decoder = new TextDecoder('utf-8')                        │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  2. 循环读取流                                                              │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │  while (true) {                                                  │    │
│     │    const { done, value } = await reader.read()                   │    │
│     │    if (done) break                                               │    │
│     │    let chunk = decoder.decode(value, { stream: true })           │    │
│     │    // 处理 chunk...                                              │    │
│     │  }                                                               │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  3. 解析 SSE 格式                                                           │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │  const split = tempResult.match(/data:.*}\n\n/g)                 │    │
│     │  for (const str of split) {                                      │    │
│     │    const data = JSONBig.parse(str.replace('data:{', '{'))        │    │
│     │    // 根据 data.type 处理...                                     │    │
│     │  }                                                               │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  4. 事件分发处理                                                            │
│     ┌─────────────────────────────────────────────────────────────────┐    │
│     │  switch (data.type) {                                            │    │
│     │    case 'id':                                                    │    │
│     │      currentRecord.id = data.id                                  │    │
│     │      break                                                       │    │
│     │    case 'sql':                                                   │    │
│     │      _currentChat.value.records[index].sql = data.content        │    │
│     │      break                                                       │    │
│     │    case 'sql-data':                                              │    │
│     │      getChatData(recordId)  // 异步获取数据                      │    │
│     │      break                                                       │    │
│     │    case 'chart':                                                 │    │
│     │      _currentChat.value.records[index].chart = data.content      │    │
│     │      break                                                       │    │
│     │    case 'finish':                                                │    │
│     │      emits('finish', currentRecord.id)                           │    │
│     │      break                                                       │    │
│     │  }                                                               │    │
│     │  await nextTick()  // 触发 Vue 响应式更新                        │    │
│     └─────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.6 图表渲染流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           图表渲染流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────┐     ┌────────────────┐     ┌────────────────────┐      │
│  │ ChartBlock.vue │────►│DisplayChartBlock│────►│ ChartComponent.vue │      │
│  │  (容器组件)     │     │  (解析配置)     │     │   (图表实例)        │      │
│  └────────────────┘     └────────────────┘     └────────────────────┘      │
│                                │                         │                  │
│                                ▼                         ▼                  │
│                    ┌─────────────────────┐   ┌─────────────────────────┐   │
│                    │ 解析 chart JSON      │   │ getChartInstance(type)  │   │
│                    │ • type: column       │   │ • Column.ts             │   │
│                    │ • axis.x: {...}      │   │ • Bar.ts                │   │
│                    │ • axis.y: {...}      │   │ • Line.ts               │   │
│                    └─────────────────────┘   │ • Pie.ts                │   │
│                                              │ • Table.ts              │   │
│                                              └─────────────────────────┘   │
│                                                          │                  │
│                                                          ▼                  │
│                                              ┌─────────────────────────┐   │
│                                              │ AntV G2 渲染             │   │
│                                              │ chart.init(axis, data)   │   │
│                                              │ chart.render()           │   │
│                                              └─────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 关键文件索引

### 4.1 后端文件

| 文件路径 | 描述 |
|---------|------|
| `backend/main.py` | FastAPI 应用入口 |
| `backend/apps/api.py` | 路由注册 |
| `backend/apps/chat/api/chat.py` | Chat API 端点 |
| `backend/apps/chat/task/llm.py` | LLM 服务核心逻辑 |
| `backend/apps/chat/models/chat_model.py` | 数据模型和 Prompt 生成 |
| `backend/apps/chat/curd/chat.py` | 数据库 CRUD 操作 |
| `backend/apps/ai_model/model_factory.py` | LLM 工厂类 |
| `backend/apps/db/db.py` | 数据库查询执行 |
| `backend/templates/template.yaml` | Prompt 模板定义 |

### 4.2 前端文件

| 文件路径 | 描述 |
|---------|------|
| `frontend/src/main.ts` | Vue 应用入口 |
| `frontend/src/api/chat.ts` | Chat API 封装 |
| `frontend/src/utils/request.ts` | HTTP 客户端 (含 fetchStream) |
| `frontend/src/views/chat/answer/ChartAnswer.vue` | 流式响应处理 |
| `frontend/src/views/chat/chat-block/ChartBlock.vue` | 图表容器 |
| `frontend/src/views/chat/component/ChartComponent.vue` | 图表组件 |
| `frontend/src/views/chat/component/DisplayChartBlock.vue` | 图表显示逻辑 |
| `frontend/src/views/chat/component/charts/*.ts` | 各类型图表实现 |

### 4.3 Prompt 模板定义

| 模板节点 | 用途 |
|---------|------|
| `template.yaml → sql.system/user` | SQL 生成 |
| `template.yaml → chart.system/user` | 图表配置 |
| `template.yaml → datasource.system/user` | 数据源选择 |
| `template.yaml → permissions.system/user` | 权限过滤 |
| `template.yaml → dynamic_sql.system/user` | 动态 SQL |
| `template.yaml → analysis.system/user` | 数据分析 |
| `template.yaml → predict.system/user` | 数据预测 |
| `template.yaml → guess.system/user` | 问题推荐 |

### 4.4 数据库特定 SQL 示例文件

**目录位置**: `backend/templates/sql_examples/`

**作用**: 为不同数据库引擎提供特定的 SQL 生成规则和示例，在 SQL 生成时自动注入到 LLM Prompt 中。

**支持的数据库**:
- MySQL.yaml
- PostgreSQL.yaml
- Oracle.yaml
- Microsoft_SQL_Server.yaml
- AWS_Redshift.yaml
- ClickHouse.yaml
- Kingbase.yaml
- DM.yaml (达梦)
- Doris.yaml
- Elasticsearch.yaml
- StarRocks.yaml

**文件结构**:
```yaml
template:
  process_check: |      # SQL生成流程步骤
  quot_rule: |          # 引号规则（MySQL用`，PostgreSQL用"）
  limit_rule: |         # 数据限制语法（LIMIT/ROWNUM/FETCH）
  other_rule: |         # 其他数据库特定规则
  basic_example: |      # SQL写法示例和错误案例
  example_engine: MySQL 8.0
  example_answer_1: |   # JSON格式答案示例
  example_answer_2: |
  example_answer_3: |
```

**如何修改**:

1. **添加数据库特定规则** - 编辑对应数据库的 YAML 文件，在 `other_rule` 中添加：
   ```yaml
   other_rule: |
     <rule>禁止使用 SELECT *，必须明确指定字段名</rule>
     <rule>所有查询必须包含 LIMIT 子句</rule>
   ```

2. **添加 SQL 示例** - 在 `basic_example` 中添加正确/错误示例：
   ```yaml
   basic_example: |
     <basic-examples>
       <example>
         <case>正确: 明确指定字段和限制</case>
         <solution>SELECT id, name, email FROM users LIMIT 100</solution>
       </example>
       <example>
         <case>错误: 使用了 SELECT *</case>
         <solution>SELECT * FROM users</solution>
         <reason>应明确列出需要的字段</reason>
       </example>
     </basic-examples>
   ```

3. **调整引号规则** - 修改 `quot_rule`：
   ```yaml
   quot_rule: |
     <rule>MySQL使用反引号`包裹表名和字段名，如 `table_name`</rule>
   ```

**调用流程**:
```
用户选择数据源（如MySQL）
    ↓
ChatQuestion.sql_sys_question(db_type='mysql')
    ↓
自动加载 backend/templates/sql_examples/MySQL.yaml
    ↓
提取规则和示例注入到 System Prompt
    ↓
LLM 根据 MySQL 特定规则生成 SQL
```

**最佳实践**:
- ✅ 用于添加数据库语法特定的规则
- ✅ 适合所有使用该数据库的用户共享的规范
- ✅ 修改后立即生效（模板有缓存机制）
- ❌ 不适合特定业务逻辑（使用 Custom Prompt 代替）
- ❌ 不适合特定客户需求（使用 Custom Prompt 代替）

---

## 附录：技术栈

| 层级 | 技术 |
|-----|------|
| 前端框架 | Vue 3 + TypeScript + Vite |
| UI 组件库 | Element Plus |
| 状态管理 | Pinia |
| 图表库 | AntV G2/S2 |
| HTTP 客户端 | Axios + Fetch API (SSE) |
| 后端框架 | FastAPI |
| LLM 框架 | LangChain |
| ORM | SQLModel + SQLAlchemy |
| 数据库 | PostgreSQL (内部) + 12种外部数据库 |
| 流式传输 | Server-Sent Events (SSE) |
